import { Directive, EventEmitter, forwardRef, Input, Output } from '@angular/core';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import { combineLatest } from 'rxjs';
import { map } from 'rxjs/operators';
import { codeBlockButton } from './code-block.button';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
export class NgxSummernoteDirective {
    constructor(el, zone, http) {
        this.el = el;
        this.zone = zone;
        this.http = http;
        // summernoteModel directive as output: update model if editor contentChanged
        this.summernoteModelChange = new EventEmitter();
        this.imageUpload = new EventEmitter();
        this.mediaDelete = new EventEmitter();
        // // summernoteInit directive as output: send manual editor initialization
        // @Output() summernoteInit: EventEmitter<Object> = new EventEmitter<Object>();
        this.blur = new EventEmitter();
        this._options = {};
        this.SPECIAL_TAGS = ['img', 'button', 'input', 'a'];
        this.INNER_HTML_ATTR = 'innerHTML';
        this._oldModel = null;
        // Begin ControlValueAccesor methods.
        this.onChange = (_) => { };
        this.onTouched = () => { };
        const element = el.nativeElement;
        // check if the element is a special tag
        if (this.SPECIAL_TAGS.indexOf(element.tagName.toLowerCase()) !== -1) {
            this._hasSpecialTag = true;
        }
        // jquery wrap and store element
        // this._$element = <any>$(element);
        this.zone = zone;
    }
    set ngxSummernote(options) {
        if (options) {
            if (!options.buttons) {
                options.buttons = {};
            }
            options.callbacks = {
                ...options.callbacks,
                onImageUpload: files => this.uploadImage(files),
                onMediaDelete: files => this.mediaDelete.emit({ url: $(files[0]).attr('src') })
            };
            // add custom buttons
            options.buttons.codeBlock = codeBlockButton;
            Object.assign(this._options, options);
        }
    }
    // summernoteModel directive as input: store initial editor content
    set summernoteModel(content) {
        this.updateEditor(content);
    }
    ngOnInit() {
        this.createEditor();
    }
    ngOnChanges(changes) {
        if (this._editorInitialized && changes) {
            if (changes.ngxSummernoteDisabled &&
                !changes.ngxSummernoteDisabled.firstChange &&
                changes.ngxSummernoteDisabled.currentValue !==
                    changes.ngxSummernoteDisabled.previousValue) {
                if (changes.ngxSummernoteDisabled.currentValue) {
                    this._$element.summernote('disable');
                }
                else {
                    this._$element.summernote('enable');
                }
            }
        }
    }
    ngOnDestroy() {
        this.destroyEditor();
        if (this.uploadSub) {
            this.uploadSub.unsubscribe();
        }
    }
    // Form model content changed.
    writeValue(content) {
        this.updateEditor(content);
    }
    registerOnChange(fn) {
        this.onChange = fn;
    }
    registerOnTouched(fn) {
        this.onTouched = fn;
    }
    // Update editor with model contents.
    updateEditor(content) {
        if (JSON.stringify(this._oldModel) === JSON.stringify(content)) {
            return;
        }
        this._oldModel = content;
        // this._$element.html(content);
        if (this._editorInitialized) {
            this._$element ? this._$element.summernote('code', content) : undefined;
        }
        else {
            this._$element ? this._$element.html(content) : undefined;
        }
    }
    // update model if editor contentChanged
    updateModel(content) {
        // console.log('update model', content)
        this.zone.run(() => {
            let modelContent = null;
            if (this._hasSpecialTag) {
                const attributeNodes = this._$element[0].attributes;
                const attrs = {};
                for (let i = 0; i < attributeNodes.length; i++) {
                    const attrName = attributeNodes[i].name;
                    if (this._options.angularIgnoreAttrs &&
                        this._options.angularIgnoreAttrs.indexOf(attrName) !== -1) {
                        continue;
                    }
                    attrs[attrName] = attributeNodes[i].value;
                }
                if (this._$element[0].innerHTML) {
                    attrs[this.INNER_HTML_ATTR] = this._$element[0].innerHTML;
                }
                modelContent = attrs;
            }
            else {
                const returnedHtml = content || '';
                if (typeof returnedHtml === 'string') {
                    modelContent = returnedHtml;
                }
            }
            if (this._oldModel !== modelContent) {
                this._oldModel = modelContent;
                // Update summernoteModel
                this.summernoteModelChange.emit(modelContent);
                // Update form model.
                this.onChange(content);
            }
        });
    }
    initListeners() {
        const self = this;
        if (!this._$element) {
            return;
        }
        this._$element.on('summernote.init', function () {
            setTimeout(function () {
                self.updateModel();
            }, 0);
        });
        this._$element.on('summernote.change', function (event, contents, $editable) {
            setTimeout(function () {
                self.updateModel(contents);
            }, 0);
        });
        this._$element.on('summernote.blur', function () {
            setTimeout(function () {
                self.onTouched();
                self.blur.emit();
            }, 0);
        });
        if (this._options.immediateAngularModelUpdate) {
            this._editor.on('keyup', function () {
                setTimeout(function () {
                    self.updateModel();
                }, 0);
            });
        }
    }
    createEditor() {
        if (this._editorInitialized) {
            return;
        }
        this.setContent(true);
        const wait = 50;
        // this.initListeners(); // issue #31
        try {
            this._$element = $(this.el.nativeElement);
        }
        catch (error) {
            console.log(`JQuery seems not te loaded yet! Wait ${wait}ms and try again`);
        }
        if (!this._$element) {
            setTimeout(() => {
                this.createEditor();
            }, wait);
        }
        else {
            // init editor
            this.zone.runOutsideAngular(() => {
                this._editor = this._$element
                    .summernote(this._options)
                    .data('summernote').$note;
                this.initListeners(); // issue #31
                if (this.ngxSummernoteDisabled) {
                    this._$element.summernote('disable');
                }
            });
            this._editorInitialized = true;
        }
    }
    setHtml() {
        this._$element.summernote('code', this._model || '', true);
    }
    setContent(firstTime = false) {
        // console.log('set content', firstTime, this._oldModel, this._model)
        const self = this;
        // Set initial content
        if (this._model || this._model === '') {
            this._oldModel = this._model;
            if (this._hasSpecialTag) {
                const tags = this._model;
                // add tags on element
                if (tags) {
                    for (const attr in tags) {
                        if (tags.hasOwnProperty(attr) && attr !== this.INNER_HTML_ATTR) {
                            this._$element.attr(attr, tags[attr]);
                        }
                    }
                    if (tags.hasOwnProperty(this.INNER_HTML_ATTR)) {
                        this._$element[0].innerHTML = tags[this.INNER_HTML_ATTR];
                    }
                }
            }
            else {
                self.setHtml();
            }
        }
    }
    destroyEditor() {
        if (this._editorInitialized) {
            this._editor.off('keyup');
            this._$element.summernote('destroy'); // TODO not sure it works now...
            this._editorInitialized = false;
        }
    }
    // private getEditor() {
    //   if (this._$element) {
    //     return this._$element.summernote.bind(this._$element);
    //   }
    //   return null;
    // }
    async uploadImage(files) {
        if (this._options.uploadImagePath) {
            this.imageUpload.emit({ uploading: true });
            const requests = [];
            for (const file of files) {
                const data = new FormData();
                data.append('image', file);
                const obs = this.http
                    .post(this._options.uploadImagePath, data, this._options.uploadImageRequestOptions)
                    .pipe(map((response) => response && typeof response.path === 'string' && response.path));
                requests.push(obs);
            }
            this.uploadSub = combineLatest(requests).subscribe((remotePaths) => {
                for (const remotePath of remotePaths) {
                    this._$element.summernote('insertImage', remotePath);
                }
                this.imageUpload.emit({ uploading: false });
            }, err => this.insertFromDataURL(files));
        }
        else {
            this.insertFromDataURL(files);
        }
    }
    insertFromDataURL(files) {
        for (const file of files) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => {
                this._$element.summernote('insertImage', reader.result);
                this.imageUpload.emit({ uploading: false, encoding: 'base64' });
            };
            reader.onerror = error => console.error(error);
        }
    }
}
NgxSummernoteDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.3.0", ngImport: i0, type: NgxSummernoteDirective, deps: [{ token: i0.ElementRef }, { token: i0.NgZone }, { token: i1.HttpClient }], target: i0.ɵɵFactoryTarget.Directive });
NgxSummernoteDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "14.3.0", type: NgxSummernoteDirective, selector: "[ngxSummernote]", inputs: { ngxSummernote: "ngxSummernote", summernoteModel: "summernoteModel", ngxSummernoteDisabled: "ngxSummernoteDisabled" }, outputs: { summernoteModelChange: "summernoteModelChange", imageUpload: "imageUpload", mediaDelete: "mediaDelete", blur: "blur" }, providers: [
        {
            provide: NG_VALUE_ACCESSOR,
            useExisting: forwardRef(() => NgxSummernoteDirective),
            multi: true
        }
    ], usesOnChanges: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.3.0", ngImport: i0, type: NgxSummernoteDirective, decorators: [{
            type: Directive,
            args: [{
                    // tslint:disable-next-line:directive-selector
                    selector: '[ngxSummernote]',
                    providers: [
                        {
                            provide: NG_VALUE_ACCESSOR,
                            useExisting: forwardRef(() => NgxSummernoteDirective),
                            multi: true
                        }
                    ]
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i0.NgZone }, { type: i1.HttpClient }]; }, propDecorators: { ngxSummernote: [{
                type: Input
            }], summernoteModel: [{
                type: Input
            }], summernoteModelChange: [{
                type: Output
            }], imageUpload: [{
                type: Output
            }], mediaDelete: [{
                type: Output
            }], blur: [{
                type: Output
            }], ngxSummernoteDisabled: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXN1bW1lcm5vdGUuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LXN1bW1lcm5vdGUvc3JjL2xpYi9uZ3gtc3VtbWVybm90ZS5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUNMLFNBQVMsRUFFVCxZQUFZLEVBQ1osVUFBVSxFQUNWLEtBQUssRUFLTCxNQUFNLEVBQ1AsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUF3QixpQkFBaUIsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3pFLE9BQU8sRUFBRSxhQUFhLEVBQWdCLE1BQU0sTUFBTSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUdyQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7OztBQWV0RCxNQUFNLE9BQU8sc0JBQXNCO0lBb0RqQyxZQUNVLEVBQWMsRUFDZCxJQUFZLEVBQ1osSUFBZ0I7UUFGaEIsT0FBRSxHQUFGLEVBQUUsQ0FBWTtRQUNkLFNBQUksR0FBSixJQUFJLENBQVE7UUFDWixTQUFJLEdBQUosSUFBSSxDQUFZO1FBNUIxQiw2RUFBNkU7UUFDbkUsMEJBQXFCLEdBQXNCLElBQUksWUFBWSxFQUFPLENBQUM7UUFDbkUsZ0JBQVcsR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUN6RCxnQkFBVyxHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDO1FBRW5FLDJFQUEyRTtRQUMzRSwrRUFBK0U7UUFFckUsU0FBSSxHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDO1FBSXBELGFBQVEsR0FBc0IsRUFBRSxDQUFDO1FBRWpDLGlCQUFZLEdBQWEsQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQztRQUN6RCxvQkFBZSxHQUFHLFdBQVcsQ0FBQztRQUs5QixjQUFTLEdBQVcsSUFB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O2dCQUtHLElBQUk7c0JBQWIsTUFBTTtnQkFFRSxxQkFBcUI7c0JBQTdCLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHtcbiAgRGlyZWN0aXZlLFxuICBFbGVtZW50UmVmLFxuICBFdmVudEVtaXR0ZXIsXG4gIGZvcndhcmRSZWYsXG4gIElucHV0LFxuICBOZ1pvbmUsXG4gIE9uQ2hhbmdlcyxcbiAgT25EZXN0cm95LFxuICBPbkluaXQsXG4gIE91dHB1dFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IENvbnRyb2xWYWx1ZUFjY2Vzc29yLCBOR19WQUxVRV9BQ0NFU1NPUiB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IGNvbWJpbmVMYXRlc3QsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBTdW1tZXJub3RlT3B0aW9ucyB9IGZyb20gJy4vc3VtbWVybm90ZS1vcHRpb25zJztcbmltcG9ydCB7IGNvZGVCbG9ja0J1dHRvbiB9IGZyb20gJy4vY29kZS1ibG9jay5idXR0b24nO1xuXG5kZWNsYXJlIHZhciAkO1xuXG5ARGlyZWN0aXZlKHtcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmRpcmVjdGl2ZS1zZWxlY3RvclxuICBzZWxlY3RvcjogJ1tuZ3hTdW1tZXJub3RlXScsXG4gIHByb3ZpZGVyczogW1xuICAgIHtcbiAgICAgIHByb3ZpZGU6IE5HX1ZBTFVFX0FDQ0VTU09SLFxuICAgICAgdXNlRXhpc3Rpbmc6IGZvcndhcmRSZWYoKCkgPT4gTmd4U3VtbWVybm90ZURpcmVjdGl2ZSksXG4gICAgICBtdWx0aTogdHJ1ZVxuICAgIH1cbiAgXVxufSlcbmV4cG9ydCBjbGFzcyBOZ3hTdW1tZXJub3RlRGlyZWN0aXZlXG4gIGltcGxlbWVudHMgQ29udHJvbFZhbHVlQWNjZXNzb3IsIE9uSW5pdCwgT25EZXN0cm95LCBPbkNoYW5nZXMge1xuICBASW5wdXQoKSBzZXQgbmd4U3VtbWVybm90ZShvcHRpb25zOiBTdW1tZXJub3RlT3B0aW9ucykge1xuICAgIGlmIChvcHRpb25zKSB7XG4gICAgICBpZiAoIW9wdGlvbnMuYnV0dG9ucykge1xuICAgICAgICBvcHRpb25zLmJ1dHRvbnMgPSB7fTtcbiAgICAgIH1cblxuICAgICAgb3B0aW9ucy5jYWxsYmFja3MgPSB7XG4gICAgICAgIC4uLm9wdGlvbnMuY2FsbGJhY2tzLFxuICAgICAgICBvbkltYWdlVXBsb2FkOiBmaWxlcyA9PiB0aGlzLnVwbG9hZEltYWdlKGZpbGVzKSxcbiAgICAgICAgb25NZWRpYURlbGV0ZTogZmlsZXMgPT5cbiAgICAgICAgICB0aGlzLm1lZGlhRGVsZXRlLmVtaXQoeyB1cmw6ICQoZmlsZXNbMF0pLmF0dHIoJ3NyYycpIH0pXG4gICAgICB9O1xuXG4gICAgICAvLyBhZGQgY3VzdG9tIGJ1dHRvbnNcbiAgICAgIG9wdGlvbnMuYnV0dG9ucy5jb2RlQmxvY2sgPSBjb2RlQmxvY2tCdXR0b247XG5cbiAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5fb3B0aW9ucywgb3B0aW9ucyk7XG4gICAgfVxuICB9XG5cbiAgLy8gc3VtbWVybm90ZU1vZGVsIGRpcmVjdGl2ZSBhcyBpbnB1dDogc3RvcmUgaW5pdGlhbCBlZGl0b3IgY29udGVudFxuICBASW5wdXQoKSBzZXQgc3VtbWVybm90ZU1vZGVsKGNvbnRlbnQ6IGFueSkge1xuICAgIHRoaXMudXBkYXRlRWRpdG9yKGNvbnRlbnQpO1xuICB9XG5cbiAgLy8gc3VtbWVybm90ZU1vZGVsIGRpcmVjdGl2ZSBhcyBvdXRwdXQ6IHVwZGF0ZSBtb2RlbCBpZiBlZGl0b3IgY29udGVudENoYW5nZWRcbiAgQE91dHB1dCgpIHN1bW1lcm5vdGVNb2RlbENoYW5nZTogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgQE91dHB1dCgpIGltYWdlVXBsb2FkOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICBAT3V0cHV0KCkgbWVkaWFEZWxldGU6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgLy8gLy8gc3VtbWVybm90ZUluaXQgZGlyZWN0aXZlIGFzIG91dHB1dDogc2VuZCBtYW51YWwgZWRpdG9yIGluaXRpYWxpemF0aW9uXG4gIC8vIEBPdXRwdXQoKSBzdW1tZXJub3RlSW5pdDogRXZlbnRFbWl0dGVyPE9iamVjdD4gPSBuZXcgRXZlbnRFbWl0dGVyPE9iamVjdD4oKTtcblxuICBAT3V0cHV0KCkgYmx1cjogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBASW5wdXQoKSBuZ3hTdW1tZXJub3RlRGlzYWJsZWQ6IGJvb2xlYW47XG5cbiAgcHJpdmF0ZSBfb3B0aW9uczogU3VtbWVybm90ZU9wdGlvbnMgPSB7fTtcblxuICBwcml2YXRlIFNQRUNJQUxfVEFHUzogc3RyaW5nW10gPSBbJ2ltZycsICdidXR0b24nLCAnaW5wdXQnLCAnYSddO1xuICBwcml2YXRlIElOTkVSX0hUTUxfQVRUUiA9ICdpbm5lckhUTUwnO1xuICBwcml2YXRlIF9oYXNTcGVjaWFsVGFnOiBib29sZWFuO1xuICBwcml2YXRlIF8kZWxlbWVudDogYW55OyAvLyBqcXVlcnkgd3JhcHBlZCBlbGVtZW50XG4gIHByaXZhdGUgX2VkaXRvcjogYW55OyAvLyBlZGl0b3IgZWxlbWVudFxuICBwcml2YXRlIF9tb2RlbDogc3RyaW5nO1xuICBwcml2YXRlIF9vbGRNb2RlbDogc3RyaW5nID0gbnVsbDtcbiAgcHJpdmF0ZSBfZWRpdG9ySW5pdGlhbGl6ZWQ6IGJvb2xlYW47XG5cbiAgcHJpdmF0ZSB1cGxvYWRTdWI6IFN1YnNjcmlwdGlvbjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGVsOiBFbGVtZW50UmVmLFxuICAgIHByaXZhdGUgem9uZTogTmdab25lLFxuICAgIHByaXZhdGUgaHR0cDogSHR0cENsaWVudFxuICApIHtcbiAgICBjb25zdCBlbGVtZW50OiBhbnkgPSBlbC5uYXRpdmVFbGVtZW50O1xuXG4gICAgLy8gY2hlY2sgaWYgdGhlIGVsZW1lbnQgaXMgYSBzcGVjaWFsIHRhZ1xuICAgIGlmICh0aGlzLlNQRUNJQUxfVEFHUy5pbmRleE9mKGVsZW1lbnQudGFnTmFtZS50b0xvd2VyQ2FzZSgpKSAhPT0gLTEpIHtcbiAgICAgIHRoaXMuX2hhc1NwZWNpYWxUYWcgPSB0cnVlO1xuICAgIH1cblxuICAgIC8vIGpxdWVyeSB3cmFwIGFuZCBzdG9yZSBlbGVtZW50XG5cbiAgICAvLyB0aGlzLl8kZWxlbWVudCA9IDxhbnk+JChlbGVtZW50KTtcblxuICAgIHRoaXMuem9uZSA9IHpvbmU7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmNyZWF0ZUVkaXRvcigpO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlcykge1xuICAgIGlmICh0aGlzLl9lZGl0b3JJbml0aWFsaXplZCAmJiBjaGFuZ2VzKSB7XG4gICAgICBpZiAoXG4gICAgICAgIGNoYW5nZXMubmd4U3VtbWVybm90ZURpc2FibGVkICYmXG4gICAgICAgICFjaGFuZ2VzLm5neFN1bW1lcm5vdGVEaXNhYmxlZC5maXJzdENoYW5nZSAmJlxuICAgICAgICBjaGFuZ2VzLm5neFN1bW1lcm5vdGVEaXNhYmxlZC5jdXJyZW50VmFsdWUgIT09XG4gICAgICAgIGNoYW5nZXMubmd4U3VtbWVybm90ZURpc2FibGVkLnByZXZpb3VzVmFsdWVcbiAgICAgICkge1xuICAgICAgICBpZiAoY2hhbmdlcy5uZ3hTdW1tZXJub3RlRGlzYWJsZWQuY3VycmVudFZhbHVlKSB7XG4gICAgICAgICAgdGhpcy5fJGVsZW1lbnQuc3VtbWVybm90ZSgnZGlzYWJsZScpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuXyRlbGVtZW50LnN1bW1lcm5vdGUoJ2VuYWJsZScpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5kZXN0cm95RWRpdG9yKCk7XG4gICAgaWYgKHRoaXMudXBsb2FkU3ViKSB7XG4gICAgICB0aGlzLnVwbG9hZFN1Yi51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuXG4gIC8vIEJlZ2luIENvbnRyb2xWYWx1ZUFjY2Vzb3IgbWV0aG9kcy5cbiAgb25DaGFuZ2UgPSAoXzogYW55KSA9PiB7IH07XG4gIG9uVG91Y2hlZCA9ICgpID0+IHsgfTtcblxuICAvLyBGb3JtIG1vZGVsIGNvbnRlbnQgY2hhbmdlZC5cbiAgd3JpdGVWYWx1ZShjb250ZW50OiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLnVwZGF0ZUVkaXRvcihjb250ZW50KTtcbiAgfVxuXG4gIHJlZ2lzdGVyT25DaGFuZ2UoZm46IChfOiBhbnkpID0+IHZvaWQpOiB2b2lkIHtcbiAgICB0aGlzLm9uQ2hhbmdlID0gZm47XG4gIH1cbiAgcmVnaXN0ZXJPblRvdWNoZWQoZm46ICgpID0+IHZvaWQpOiB2b2lkIHtcbiAgICB0aGlzLm9uVG91Y2hlZCA9IGZuO1xuICB9XG5cbiAgLy8gVXBkYXRlIGVkaXRvciB3aXRoIG1vZGVsIGNvbnRlbnRzLlxuICBwcml2YXRlIHVwZGF0ZUVkaXRvcihjb250ZW50OiBhbnkpIHtcbiAgICBpZiAoSlNPTi5zdHJpbmdpZnkodGhpcy5fb2xkTW9kZWwpID09PSBKU09OLnN0cmluZ2lmeShjb250ZW50KSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMuX29sZE1vZGVsID0gY29udGVudDtcbiAgICAvLyB0aGlzLl8kZWxlbWVudC5odG1sKGNvbnRlbnQpO1xuXG4gICAgaWYgKHRoaXMuX2VkaXRvckluaXRpYWxpemVkKSB7XG4gICAgICB0aGlzLl8kZWxlbWVudCA/IHRoaXMuXyRlbGVtZW50LnN1bW1lcm5vdGUoJ2NvZGUnLCBjb250ZW50KSA6IHVuZGVmaW5lZDtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fJGVsZW1lbnQgPyB0aGlzLl8kZWxlbWVudC5odG1sKGNvbnRlbnQpIDogdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxuXG4gIC8vIHVwZGF0ZSBtb2RlbCBpZiBlZGl0b3IgY29udGVudENoYW5nZWRcbiAgcHJpdmF0ZSB1cGRhdGVNb2RlbChjb250ZW50PzogYW55KSB7XG4gICAgLy8gY29uc29sZS5sb2coJ3VwZGF0ZSBtb2RlbCcsIGNvbnRlbnQpXG4gICAgdGhpcy56b25lLnJ1bigoKSA9PiB7XG4gICAgICBsZXQgbW9kZWxDb250ZW50OiBhbnkgPSBudWxsO1xuXG4gICAgICBpZiAodGhpcy5faGFzU3BlY2lhbFRhZykge1xuICAgICAgICBjb25zdCBhdHRyaWJ1dGVOb2RlcyA9IHRoaXMuXyRlbGVtZW50WzBdLmF0dHJpYnV0ZXM7XG4gICAgICAgIGNvbnN0IGF0dHJzID0ge307XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhdHRyaWJ1dGVOb2Rlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIGNvbnN0IGF0dHJOYW1lID0gYXR0cmlidXRlTm9kZXNbaV0ubmFtZTtcbiAgICAgICAgICBpZiAoXG4gICAgICAgICAgICB0aGlzLl9vcHRpb25zLmFuZ3VsYXJJZ25vcmVBdHRycyAmJlxuICAgICAgICAgICAgdGhpcy5fb3B0aW9ucy5hbmd1bGFySWdub3JlQXR0cnMuaW5kZXhPZihhdHRyTmFtZSkgIT09IC0xXG4gICAgICAgICAgKSB7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYXR0cnNbYXR0ck5hbWVdID0gYXR0cmlidXRlTm9kZXNbaV0udmFsdWU7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5fJGVsZW1lbnRbMF0uaW5uZXJIVE1MKSB7XG4gICAgICAgICAgYXR0cnNbdGhpcy5JTk5FUl9IVE1MX0FUVFJdID0gdGhpcy5fJGVsZW1lbnRbMF0uaW5uZXJIVE1MO1xuICAgICAgICB9XG5cbiAgICAgICAgbW9kZWxDb250ZW50ID0gYXR0cnM7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCByZXR1cm5lZEh0bWw6IGFueSA9IGNvbnRlbnQgfHwgJyc7XG4gICAgICAgIGlmICh0eXBlb2YgcmV0dXJuZWRIdG1sID09PSAnc3RyaW5nJykge1xuICAgICAgICAgIG1vZGVsQ29udGVudCA9IHJldHVybmVkSHRtbDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKHRoaXMuX29sZE1vZGVsICE9PSBtb2RlbENvbnRlbnQpIHtcbiAgICAgICAgdGhpcy5fb2xkTW9kZWwgPSBtb2RlbENvbnRlbnQ7XG4gICAgICAgIC8vIFVwZGF0ZSBzdW1tZXJub3RlTW9kZWxcbiAgICAgICAgdGhpcy5zdW1tZXJub3RlTW9kZWxDaGFuZ2UuZW1pdChtb2RlbENvbnRlbnQpO1xuICAgICAgICAvLyBVcGRhdGUgZm9ybSBtb2RlbC5cbiAgICAgICAgdGhpcy5vbkNoYW5nZShjb250ZW50KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdExpc3RlbmVycygpIHtcbiAgICBjb25zdCBzZWxmID0gdGhpcztcblxuICAgIGlmICghdGhpcy5fJGVsZW1lbnQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLl8kZWxlbWVudC5vbignc3VtbWVybm90ZS5pbml0JywgZnVuY3Rpb24gKCkge1xuICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgIHNlbGYudXBkYXRlTW9kZWwoKTtcbiAgICAgIH0sIDApO1xuICAgIH0pO1xuXG4gICAgdGhpcy5fJGVsZW1lbnQub24oJ3N1bW1lcm5vdGUuY2hhbmdlJywgZnVuY3Rpb24gKFxuICAgICAgZXZlbnQsXG4gICAgICBjb250ZW50cyxcbiAgICAgICRlZGl0YWJsZVxuICAgICkge1xuICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgIHNlbGYudXBkYXRlTW9kZWwoY29udGVudHMpO1xuICAgICAgfSwgMCk7XG4gICAgfSk7XG5cbiAgICB0aGlzLl8kZWxlbWVudC5vbignc3VtbWVybm90ZS5ibHVyJywgZnVuY3Rpb24gKCkge1xuICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgIHNlbGYub25Ub3VjaGVkKCk7XG4gICAgICAgIHNlbGYuYmx1ci5lbWl0KCk7XG4gICAgICB9LCAwKTtcbiAgICB9KTtcblxuICAgIGlmICh0aGlzLl9vcHRpb25zLmltbWVkaWF0ZUFuZ3VsYXJNb2RlbFVwZGF0ZSkge1xuICAgICAgdGhpcy5fZWRpdG9yLm9uKCdrZXl1cCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgc2VsZi51cGRhdGVNb2RlbCgpO1xuICAgICAgICB9LCAwKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlRWRpdG9yKCkge1xuICAgIGlmICh0aGlzLl9lZGl0b3JJbml0aWFsaXplZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMuc2V0Q29udGVudCh0cnVlKTtcblxuICAgIGNvbnN0IHdhaXQgPSA1MDtcbiAgICAvLyB0aGlzLmluaXRMaXN0ZW5lcnMoKTsgLy8gaXNzdWUgIzMxXG4gICAgdHJ5IHtcbiAgICAgIHRoaXMuXyRlbGVtZW50ID0gPGFueT4kKHRoaXMuZWwubmF0aXZlRWxlbWVudCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUubG9nKGBKUXVlcnkgc2VlbXMgbm90IHRlIGxvYWRlZCB5ZXQhIFdhaXQgJHt3YWl0fW1zIGFuZCB0cnkgYWdhaW5gKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuXyRlbGVtZW50KSB7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgdGhpcy5jcmVhdGVFZGl0b3IoKTtcbiAgICAgIH0sIHdhaXQpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBpbml0IGVkaXRvclxuICAgICAgdGhpcy56b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgICAgdGhpcy5fZWRpdG9yID0gdGhpcy5fJGVsZW1lbnRcbiAgICAgICAgICAuc3VtbWVybm90ZSh0aGlzLl9vcHRpb25zKVxuICAgICAgICAgIC5kYXRhKCdzdW1tZXJub3RlJykuJG5vdGU7XG5cbiAgICAgICAgdGhpcy5pbml0TGlzdGVuZXJzKCk7IC8vIGlzc3VlICMzMVxuXG4gICAgICAgIGlmICh0aGlzLm5neFN1bW1lcm5vdGVEaXNhYmxlZCkge1xuICAgICAgICAgIHRoaXMuXyRlbGVtZW50LnN1bW1lcm5vdGUoJ2Rpc2FibGUnKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICB0aGlzLl9lZGl0b3JJbml0aWFsaXplZCA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXRIdG1sKCkge1xuICAgIHRoaXMuXyRlbGVtZW50LnN1bW1lcm5vdGUoJ2NvZGUnLCB0aGlzLl9tb2RlbCB8fCAnJywgdHJ1ZSk7XG4gIH1cblxuICBwcml2YXRlIHNldENvbnRlbnQoZmlyc3RUaW1lID0gZmFsc2UpIHtcbiAgICAvLyBjb25zb2xlLmxvZygnc2V0IGNvbnRlbnQnLCBmaXJzdFRpbWUsIHRoaXMuX29sZE1vZGVsLCB0aGlzLl9tb2RlbClcbiAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICAvLyBTZXQgaW5pdGlhbCBjb250ZW50XG4gICAgaWYgKHRoaXMuX21vZGVsIHx8IHRoaXMuX21vZGVsID09PSAnJykge1xuICAgICAgdGhpcy5fb2xkTW9kZWwgPSB0aGlzLl9tb2RlbDtcbiAgICAgIGlmICh0aGlzLl9oYXNTcGVjaWFsVGFnKSB7XG4gICAgICAgIGNvbnN0IHRhZ3M6IE9iamVjdCA9IHRoaXMuX21vZGVsO1xuICAgICAgICAvLyBhZGQgdGFncyBvbiBlbGVtZW50XG4gICAgICAgIGlmICh0YWdzKSB7XG4gICAgICAgICAgZm9yIChjb25zdCBhdHRyIGluIHRhZ3MpIHtcbiAgICAgICAgICAgIGlmICh0YWdzLmhhc093blByb3BlcnR5KGF0dHIpICYmIGF0dHIgIT09IHRoaXMuSU5ORVJfSFRNTF9BVFRSKSB7XG4gICAgICAgICAgICAgIHRoaXMuXyRlbGVtZW50LmF0dHIoYXR0ciwgdGFnc1thdHRyXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKHRhZ3MuaGFzT3duUHJvcGVydHkodGhpcy5JTk5FUl9IVE1MX0FUVFIpKSB7XG4gICAgICAgICAgICB0aGlzLl8kZWxlbWVudFswXS5pbm5lckhUTUwgPSB0YWdzW3RoaXMuSU5ORVJfSFRNTF9BVFRSXTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHNlbGYuc2V0SHRtbCgpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZGVzdHJveUVkaXRvcigpIHtcbiAgICBpZiAodGhpcy5fZWRpdG9ySW5pdGlhbGl6ZWQpIHtcbiAgICAgIHRoaXMuX2VkaXRvci5vZmYoJ2tleXVwJyk7XG4gICAgICB0aGlzLl8kZWxlbWVudC5zdW1tZXJub3RlKCdkZXN0cm95Jyk7IC8vIFRPRE8gbm90IHN1cmUgaXQgd29ya3Mgbm93Li4uXG4gICAgICB0aGlzLl9lZGl0b3JJbml0aWFsaXplZCA9IGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIC8vIHByaXZhdGUgZ2V0RWRpdG9yKCkge1xuICAvLyAgIGlmICh0aGlzLl8kZWxlbWVudCkge1xuICAvLyAgICAgcmV0dXJuIHRoaXMuXyRlbGVtZW50LnN1bW1lcm5vdGUuYmluZCh0aGlzLl8kZWxlbWVudCk7XG4gIC8vICAgfVxuXG4gIC8vICAgcmV0dXJuIG51bGw7XG4gIC8vIH1cblxuICBwcml2YXRlIGFzeW5jIHVwbG9hZEltYWdlKGZpbGVzKSB7XG4gICAgaWYgKHRoaXMuX29wdGlvbnMudXBsb2FkSW1hZ2VQYXRoKSB7XG4gICAgICB0aGlzLmltYWdlVXBsb2FkLmVtaXQoeyB1cGxvYWRpbmc6IHRydWUgfSk7XG5cbiAgICAgIGNvbnN0IHJlcXVlc3RzID0gW107XG4gICAgICBmb3IgKGNvbnN0IGZpbGUgb2YgZmlsZXMpIHtcbiAgICAgICAgY29uc3QgZGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xuICAgICAgICBkYXRhLmFwcGVuZCgnaW1hZ2UnLCBmaWxlKTtcbiAgICAgICAgY29uc3Qgb2JzID0gdGhpcy5odHRwXG4gICAgICAgICAgLnBvc3QodGhpcy5fb3B0aW9ucy51cGxvYWRJbWFnZVBhdGgsIGRhdGEsIHRoaXMuX29wdGlvbnMudXBsb2FkSW1hZ2VSZXF1ZXN0T3B0aW9ucylcbiAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgIG1hcChcbiAgICAgICAgICAgICAgKHJlc3BvbnNlOiB7IHBhdGg6IHN0cmluZyB9KSA9PlxuICAgICAgICAgICAgICAgIHJlc3BvbnNlICYmIHR5cGVvZiByZXNwb25zZS5wYXRoID09PSAnc3RyaW5nJyAmJiByZXNwb25zZS5wYXRoXG4gICAgICAgICAgICApXG4gICAgICAgICAgKTtcbiAgICAgICAgcmVxdWVzdHMucHVzaChvYnMpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnVwbG9hZFN1YiA9IGNvbWJpbmVMYXRlc3QocmVxdWVzdHMpLnN1YnNjcmliZShcbiAgICAgICAgKHJlbW90ZVBhdGhzOiBzdHJpbmdbXSkgPT4ge1xuICAgICAgICAgIGZvciAoY29uc3QgcmVtb3RlUGF0aCBvZiByZW1vdGVQYXRocykge1xuICAgICAgICAgICAgdGhpcy5fJGVsZW1lbnQuc3VtbWVybm90ZSgnaW5zZXJ0SW1hZ2UnLCByZW1vdGVQYXRoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5pbWFnZVVwbG9hZC5lbWl0KHsgdXBsb2FkaW5nOiBmYWxzZSB9KTtcbiAgICAgICAgfSxcbiAgICAgICAgZXJyID0+IHRoaXMuaW5zZXJ0RnJvbURhdGFVUkwoZmlsZXMpXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmluc2VydEZyb21EYXRhVVJMKGZpbGVzKTtcbiAgICB9XG4gIH1cblxuICBpbnNlcnRGcm9tRGF0YVVSTChmaWxlcykge1xuICAgIGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcykge1xuICAgICAgY29uc3QgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTtcbiAgICAgIHJlYWRlci5yZWFkQXNEYXRhVVJMKGZpbGUpO1xuICAgICAgcmVhZGVyLm9ubG9hZCA9ICgpID0+IHtcbiAgICAgICAgdGhpcy5fJGVsZW1lbnQuc3VtbWVybm90ZSgnaW5zZXJ0SW1hZ2UnLCByZWFkZXIucmVzdWx0KTtcbiAgICAgICAgdGhpcy5pbWFnZVVwbG9hZC5lbWl0KHsgdXBsb2FkaW5nOiBmYWxzZSwgZW5jb2Rpbmc6ICdiYXNlNjQnIH0pO1xuICAgICAgfTtcbiAgICAgIHJlYWRlci5vbmVycm9yID0gZXJyb3IgPT4gY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgfVxuICB9XG59XG4iXX0=